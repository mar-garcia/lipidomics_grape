---
title: "Identification"
author: "Mar Garcia-Aloy"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: false
    number_sections: false
    toc_float: false
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
study <- "tissues" # specify "maturation" or "tissues"
source("../../R/ft_group.R")

feat <- read.csv(paste0(study, "/data/features.csv"))

modes <- c("POS", "NEG")
for(i in 1:2){
  load(paste0(study, "/data/RData/data_XCMS_", modes[i], ".RData"))
  my.data <- dt_preparation(xobj = xdata, class = "tissue", mznoise = c())
  
  load(paste0(study, "/data/RData/MS2_library_", modes[i], ".RData"))
  my.ft <- feat$X[which(substr(feat$beh, 1, 4) == "pulp" & 
                     substr(feat$X, 1, 1) == substr(modes[i], 1, 1))]
  my.data <- ft_grouping(
    datax = my.data, MS2x = ms2list, 
    ft_idx = which(rownames(my.data[["features"]]) %in% my.ft), 
    rt_d = 5)
  assign(paste0("my.data_", tolower(modes[i])), my.data)
}

my.features <- isotopologues(
  features = rbind(my.data_pos[["features"]], my.data_neg[["features"]]))

for(i in 1:2){
  my.data_x <- get(paste0("my.data_", tolower(modes[i])))
  my.data_x <- my.data_x[["data"]]
  if(study == "tissues"){
    colnames(my.data_x) <- gsub(".*tissues_", "", colnames(my.data_x))
  }
  my.data_x <- my.data_x[, order(colnames(my.data_x))]
  assign(paste0("data_", tolower(modes[i])), my.data_x)
}


my.features <- fg_grouping(data = rbind(data_pos, data_neg), 
                           features = my.features)

cmps <- read.csv("compounds_RT_formula.csv")
cmps$RT <- cmps$RT*60
cmps$mass <- NA
for(i in seq(nrow(cmps))){
  cmps$mass[i] <- getMolecule(cmps$formula[i])$exactmass
}
load(paste0(study, "/data/RData/MS2_library_POS.RData"))
ms2list_pos <- ms2list
load(paste0(study, "/data/RData/MS2_library_NEG.RData"))
ms2list <- c(ms2list, ms2list_pos)
my.dt_ids <- identification(features = my.features, cmps, MS2x = ms2list, rt_d = 120)
dt_fg <- my.dt_ids[["dt_fg"]]

dt_fg$beh <- NA
ft <- my.dt_ids[["features"]]
ft <- ft[!is.na(ft$FGx),]
for(i in seq(nrow(dt_fg))){
  tmp <- data.frame(table(feat$beh[feat$X %in% rownames(ft)[ft$FGx == dt_fg$FG[i]]]))
  dt_fg$beh[i] <- paste(tmp$Var1[tmp$Freq == tmp$Freq[which.max(tmp$Freq)]], collapse = "; ")
}

dt_fg$check <- 0
check <- read.csv("identifications_checked.csv")
for(i in seq(nrow(check))){
  i.idx <- unlist(matchWithPpm(getMolecule(check$formula[i])$exactmass, dt_fg$mass, ppm = 10))
  dt_fg$check[i.idx] <- 1
}


dt_fg <- dt_fg[order(dt_fg$beh, as.numeric(dt_fg$RT)), ]
library(DT)
datatable(dt_fg[,-which(colnames(dt_fg) == "mass")], rownames = FALSE, 
              options = list(pageLength = nrow(dt_fg), dom = 't')) %>% 
  formatStyle("check", target = "row", 
              backgroundColor = styleEqual(
                c(0, 1), c('', 'lightblue')))
save.image(paste0("ID_", study, ".RData"))
```


# Session information

```{r session}
Sys.time()-startpoint
devtools::session_info()
```
