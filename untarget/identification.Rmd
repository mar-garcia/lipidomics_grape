---
title: "Identification"
author: "Mar Garcia-Aloy"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: false
    number_sections: false
    toc_float: false
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
study <- "tissues" # specify "maturation" or "tissues"
source("../../R/ft_group.R")

feat_prep <- function(flname){
  feat <- read.csv(flname)
  feat$tissue <- NA
  feat$tissue <- gsub(").*", "", feat$beh)
  feat$tissue <- gsub("\\(", "", feat$tissue)
  feat$tissue <- gsub(" >.*", "", feat$tissue)
  feat$tissue[feat$beh == "NS"] <- "NS"
  return(feat)
}

feat_tissu <- feat_prep(paste0(study, "/data/features_grtissue.csv"))
feat_grape <- feat_prep(paste0(study, "/data/features_grgrape.csv"))

table(feat_grape$tissue, feat_tissu$tissue)
my.ft <- feat_tissu$X[feat_grape$tissue == "pulp" & feat_tissu$tissue == "pulp"]

modes <- c("POS", "NEG")
for(i in 1:2){
  load(paste0(study, "/data/RData/data_XCMS_", modes[i], ".RData"))
  my.data <- dt_preparation(xobj = xdata, class = "tissue", mznoise = c())
  
  load(paste0(study, "/data/RData/MS2_library_", modes[i], ".RData"))
  my.data <- ft_grouping(
    datax = my.data, MS2x = ms2, 
    ft_idx = which(rownames(my.data[["features"]]) %in% my.ft), 
    rt_d = 5)
  assign(paste0("my.data_", tolower(modes[i])), my.data)
}

my.features <- isotopologues(
  features = rbind(my.data_pos[["features"]], my.data_neg[["features"]]))

for(i in 1:2){
  my.data_x <- get(paste0("my.data_", tolower(modes[i])))
  my.data_x <- my.data_x[["data"]]
  if(study == "tissues"){
    colnames(my.data_x) <- gsub(".*tissues_", "", colnames(my.data_x))
  }
  my.data_x <- my.data_x[, order(colnames(my.data_x))]
  assign(paste0("data_", tolower(modes[i])), my.data_x)
}


my.features <- fg_grouping(data = rbind(data_pos, data_neg), 
                           features = my.features)

cmps <- read.csv("compounds_RT_formula.csv")
cmps$RT <- cmps$RT*60
cmps$mass <- NA
for(i in seq(nrow(cmps))){
  cmps$mass[i] <- getMolecule(cmps$formula[i])$exactmass
}
load(paste0(study, "/data/RData/MS2_library_POS.RData"))
ms2_pos <- ms2
load(paste0(study, "/data/RData/MS2_library_NEG.RData"))
ms2 <- c(ms2, ms2_pos)
my.dt_ids <- identification(features = my.features, cmps, MS2x = ms2, rt_d = 120)
dt_fg <- my.dt_ids[["dt_fg"]]

dt_fg$beh_grape <- NA
dt_fg$beh_tissue <- NA
ft <- my.dt_ids[["features"]]
ft <- ft[!is.na(ft$FGx),]
for(i in seq(nrow(dt_fg))){
  tmp_grape <- data.frame(table(feat_grape$beh[feat_grape$X %in% rownames(ft)[ft$FGx == dt_fg$FG[i]]]))
  tmp_tissu <- data.frame(table(feat_tissu$beh[feat_tissu$X %in% rownames(ft)[ft$FGx == dt_fg$FG[i]]]))
  dt_fg$beh_grape[i] <- paste(tmp_grape$Var1[tmp_grape$Freq == tmp_grape$Freq[which.max(tmp_grape$Freq)]], collapse = "; ")
  dt_fg$beh_tissue[i] <- paste(tmp_tissu$Var1[tmp_tissu$Freq == tmp_tissu$Freq[which.max(tmp_tissu$Freq)]], collapse = "; ")
}

dt_fg$check <- 0
check <- read.csv("identifications_checked.csv")
for(i in seq(nrow(check))){
  i.idx <- unlist(matchWithPpm(getMolecule(check$formula[i])$exactmass, dt_fg$mass, ppm = 10))
  dt_fg$check[i.idx] <- 1
}


dt_fg <- dt_fg[order(dt_fg$beh_grape, dt_fg$beh_tissue, as.numeric(dt_fg$RT)), ]
library(DT)
datatable(dt_fg[,-which(colnames(dt_fg) == "mass")], rownames = FALSE, 
          options = list(pageLength = nrow(dt_fg), dom = 't')) %>% 
  formatStyle("check", target = "row", 
              backgroundColor = styleEqual(
                c(0, 1), c('', 'lightblue')))
save.image(paste0("ID_", study, ".RData"))
```


# Session information

```{r session}
Sys.time()-startpoint
devtools::session_info()
```
