---
title: "Data analysis: maturation"
author: "Mar Garcia-Aloy"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    number_sections: false
    toc_float: true
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

In this document we first import the data from both polarities processed with XCMS and then we filter the potential problematic features.  
Following, we do an unsupervised exploratory analysis and later we select those features with specific trends over time.

# Libraries

```{r}
library(xcms)
library(plotly)
library(pheatmap)
library(RColorBrewer)
library(mgcv)

CV <- function(x){(sd(x, na.rm = T) / mean(x, na.rm = T))*100}
scaling.pareto <- BioMark::scalefun(sc.p="pareto")
```


# Data import

```{r}
modes <- c("POS", "NEG")
for(i in 1:2){
  load(paste0("data/RData/data_XCMS_", modes[i], ".RData"))
  #xdata_notfill <- dropFilledChromPeaks(xdata)
  
  dt <- featureValues(xdata, method = "sum", value = "into")
  rownames(dt) <- gsub("FT", substr(modes[i], 1, 1), rownames(dt))
  colnames(dt) <- gsub(paste0("_", modes[i], "_FS.mzData"), "", colnames(dt))
  colnames(dt) <- gsub(".*tissues_", "", colnames(dt))
  dt <- dt[, order(colnames(dt))]
  assign(paste0("dt_", tolower(modes[i])), dt)
  
  #dt_notfill <- featureValues(xdata_notfill, method = "sum", value = "into")
  #rownames(dt_notfill) <- gsub("FT", substr(modes[i], 1, 1), rownames(dt_notfill))
  #colnames(dt_notfill) <- gsub(paste0("_", modes[i], "_FS.mzData"), "", colnames(dt_notfill))
  #colnames(dt_notfill) <- gsub(".*tissues_", "", colnames(dt_notfill))
  #dt_notfill <- dt_notfill[, order(colnames(dt_notfill))]
  #assign(paste0("dt_notfill_", tolower(modes[i])), dt_notfill)
  
  ft <- data.frame(featureDefinitions(xdata))
  rownames(ft) <- gsub("FT", substr(modes[i], 1, 1), rownames(ft))
  assign(paste0("ft_", tolower(modes[i])), ft)
}

data <- rbind(dt_pos, dt_neg)
feat <- rbind(ft_pos, ft_neg)
class <- substr(colnames(data), 17, 21)
class[grep("QC", colnames(data))] <- "QC"
class[grep("slv", colnames(data))] <- "solv"
rm(i, xdata, dt, ft, modes, dt_pos, dt_neg, ft_pos, ft_neg)
```


# Data filtering

Before starting with any type of analysis we remove potentially problematic features keeping those with:  
  
  - Measurements in at least 2 out of 3 samples from any tissue of interest (i.e., skin, pulp or seeds)  
  - A coefficient of variation (CV) <30% in QC samples  
  - A correlation to dilution < 0.8

```{r}
sp_ts <- grep("_Pt_", colnames(data))
ts_n <- feat$study

sp_QC <- grep("xx_00_xQC", colnames(data))
data_QC <- data[, sp_QC]
CV_QC <- apply(data_QC, 1, CV)
CV_QC[is.na(CV_QC)] <- 0
int_QC <- apply(data_QC, 1, mean, na.rm=TRUE)
int_QC[is.na(int_QC)] <- 0
par(mfrow = c(1, 2))
plot(int_QC, CV_QC)
plot(int_QC, CV_QC, xlim = c(0, quantile(int_QC, 0.9)))


sp_ln <- grep("QCdl_|QCrw_", colnames(data))
data_ln <- data[, sp_ln]
dil <- colnames(data_ln)
dil <- gsub("uL_0.*", "", dil)
dil1 <- rep(1, length(dil))
dil1[grep("QCdl", dil)] <- 10
dil1 <- as.numeric(dil1)
dil2 <- gsub(".*_", "", dil)
dil2 <- gsub("02", "2.5", dil2)
dil2 <- as.numeric(dil2)
dil <- dil2 / dil1
rm(dil1, dil2)
data_ln[is.na(data_ln)] <- 0
dil_ln <- c()
for(i in seq(nrow(data_ln))){
  dil_ln <- c(dil_ln, cor(dil, data_ln[i, ]))
}
dil_ln[is.na(dil_ln)] <- 0
plot(int_QC, dil_ln)
plot(int_QC, dil_ln, xlim = c(0, quantile(int_QC, 0.9)))

grid::grid.newpage()
VennDiagram::draw.triple.venn(
  area1 = sum(ts_n > 1),
  area2 = sum(CV_QC < 30),
  area3 = sum(dil_ln > 0.8),
  n12 = sum(ts_n > 1 & CV_QC < 30),
  n13 = sum(ts_n > 1 & dil_ln > 0.8),
  n23 = sum(CV_QC < 30 & dil_ln > 0.8),
  n123= sum(ts_n > 1 & CV_QC < 30 & dil_ln > 0.8), 
  category = c(">2 study samples", "CV(QC) < 30%", "Linearity > 0.8"), 
  fill = c("#E69F00", "#56B4E9", "#009E73"))

ft_ok <- which(ts_n > 1 & CV_QC < 30 & dil_ln > 0.8)
feat <- feat[ft_ok,]
rm(data_QC, data_ln, ts_n, CV_QC, dil_ln, int_QC)
```

# Exploratory data analysis

As mentioned, we start with an exploratory analysis of the data.

## PCA

```{r}
set.seed(123)
dt <- t(imputeRowMinRand(as.matrix(data[ft_ok, sp_ts]), method = "from_to",
                         min_fraction = 1/100,
                         min_fraction_from = 1/1000))
dt <- log10(dt)
dt <- data.frame(scaling.pareto(dt))
pca <- prcomp(dt, center = FALSE, scale. = FALSE)
tmp <- data.frame(pca$x)
plot_ly(x = tmp$PC1, y = tmp$PC2,
        text = rownames(tmp),
        color = class[sp_ts])

class2 <- class[sp_ts]
class2[class2 %in% c("Pt_01", "Pt_02", "Pt_03", "Pt_04", "Pt_05", 
                     "Pt_06")] <- "Pt_01_06"
class2[class2 %in% c("Pt_07", "Pt_08", "Pt_09", "Pt_10", "Pt_11", 
                     "Pt_12", "Pt_13")] <- "Pt_07_13"
plot_ly(x = tmp$PC1, y = tmp$PC2,
        text = rownames(tmp),
        color = class2, colors = "Set1")

summary(pca)$importance
```


```{r}
tmp <- data.frame(pca$rotation)
plot_ly(x = tmp$PC1, y = tmp$PC2,
        text = rownames(tmp),
        color = substr(rownames(tmp), 1, 1))
```


## Heatmap

```{r}
dt_tissue <- data.frame(tissue = class[sp_ts])
rownames(dt_tissue) <- rownames(dt)

dt_mode <- data.frame(mode = substr(colnames(dt), 1, 1))
rownames(dt_mode) <- colnames(dt)

pheatmap(dt, show_colnames = F, 
         annotation_row = dt_tissue, annotation_col = dt_mode)
```



# Differential abundance analysis

```{r}
set.seed(123)
dt <- t(imputeRowMinRand(as.matrix(data[ft_ok, sp_ts]), method = "from_to",
                         min_fraction = 1/100,
                         min_fraction_from = 1/1000))

brix <- readxl::read_excel("../../target/data/Grape_Brix_Datafile.xlsx")
brix$data <- as.character(brix$data)
brix <- rbind(brix, 
              c(2019, "diradamento", "corno - az. Oliva", "2019-09-17", "C", 0, 
                mean(brix$Brix[brix$data == "2019-09-17"])),
              c(2019, "diradamento", "corno - az. Oliva", "2019-09-24", "C", 0, 
                mean(brix$Brix[brix$data == "2019-09-24"])))
brix <- brix[order(brix$data, brix$Replicate), ]
xtime <- as.integer(as.Date(brix$data))
stat.gam <- function(x){
  as.numeric(unlist(summary(
    gam(log10(x) ~ s(xtime), method = "REML", gamma = 1.4)
  ))["s.table4"])
}
pval <- apply(FUN = stat.gam, MARGIN = 2, X = dt)
padj <- p.adjust(pval, "BH")
par(mfrow = c(1, 2))
hist(pval, breaks = 32)
hist(padj, breaks = 32)
sum(padj < 0.05)

dt <- dt[,padj < 0.05 #& dev > 0.7
         ]
data_st_log <- log10(dt)
data_st_log_s <- scale(data_st_log)


ytimes <- seq(min(xtime), max(xtime))
dt_pred <- matrix(NA, nrow = length(ytimes), ncol = ncol(dt))
colnames(dt_pred) <- colnames(dt)
for(i in seq(ncol(dt_pred))){
  dt_pred[,i] <- predict.gam(
    gam(log10(dt[,i]) ~ s(xtime), method = "REML", gamma = 1.4), 
    data.frame(xtime = ytimes))  
}
dt_pred_s <- scale(dt_pred)
dt_pred_s_t <- t(dt_pred_s)

par(mfrow=c(1,1))
i <- 1
plot(xtime, data_st_log_s[,i], pch = 16, 
       ylim = c(min(c(dt_pred_s_t, data_st_log_s)), 
                max(c(dt_pred_s_t, data_st_log_s))))
points(ytimes, dt_pred_s_t[i,], pch = 16, type = "l", lwd = 2)
for(i in 2:ncol(dt)){
  points(xtime, data_st_log_s[,i], pch = 16, col = i)
  points(ytimes, dt_pred_s_t[i,], pch = 16, type = "l", lwd = 2, col = i)
}
```



# Session information

```{r session}
write.csv(feat[,c(1:7#, (which(colnames(feat) == "ms_level") + 1):ncol(feat)
                  )], 
          "data/features.csv")
Sys.time()-startpoint
devtools::session_info()
```
