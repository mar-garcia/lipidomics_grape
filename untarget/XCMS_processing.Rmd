---
title: "XCMS processing"
author: "Mar Garcia-Aloy"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
```


# Preliminaries

## Parameters

```{r parameters}
polarity <- "POS" # specify "POS" or "NEG"
study <- "maturation" # specify "maturation" or "tissues"

if(polarity == "NEG"){
  if(study == "tissues"){
    int <- 6e5
  } else if(study == "maturation"){
    int <- 3e5
  }
} else if(polarity == "POS"){
  if(study == "tissues"){
    int <- 1e7
  } else if(study == "maturation"){
    int <- 4e6
  }
}

if(study == "maturation"){
  v.class <- "type"
} else if(study == "tissues"){
  v.class <- "tissue"
}
```


## Libraries

```{r libraries, message = FALSE, warning = FALSE}
library(xcms)
```


# Data import

```{r data-import}
#  Get filenames
injections <- data.frame(
  filename = list.files(paste0(study, "/data/", polarity, "_FS_fixed/"))
)
tmp <- strsplit(gsub(".mzData", "", injections$filename), "_")
tmp <- data.frame(do.call(rbind, tmp))
if(study == "maturation"){
  colnames(tmp) <- c("order", "project", "pt", "time", "type", "rep", 
                     "polarity", "mode")
  tmp$mode[tmp$polarity == "FS"] <- tmp$polarity[tmp$polarity == "FS"] 
  tmp$polarity[tmp$polarity == "FS"] <- tmp$rep[tmp$polarity == "FS"] 
  tmp$polarity[tmp$polarity == "FS"] <- tmp$rep[tmp$polarity == "FS"] 
  tmp$rep[tmp$rep == polarity] <- tmp$type[tmp$rep == polarity] 
  idx <- tmp$time %in% c("solveq", "blank", "STDmix")
  tmp$type[idx] <- tmp$time[idx]
  tmp$time[idx] <- 0
  idx <- grep("QC", tmp$pt)
  tmp$type[idx] <- paste(tmp$pt[idx], tmp$time[idx], sep = "_")
  tmp$pt[idx] <- "xx"
  tmp$time[idx] <- 0
  tmp$type[tmp$type == "Rep" | tmp$type == "MIX"] <- "study"
} else if(study == "tissues"){
  tmp$X2 <- paste(tmp$X2, tmp$X3, sep = "_")
  tmp <- tmp[,-3]
  colnames(tmp) <- c("order", "project", "pt", "tissue", "rep", "polarity", "mode")
  tmp$tissue[grep("QC", tmp$pt)] <- paste(tmp$pt[grep("QC", tmp$pt)], 
                                          tmp$tissue[grep("QC", tmp$pt)], sep = "_")
  tmp$pt[grep("QC", tmp$pt)] <- "xx00"
  #tmp$tissue[tmp$tissue == "entire" | tmp$tissue == "skin" | 
  #             tmp$tissue == "pulp" | tmp$tissue == "seeds"] <- "study"
}

injections <- cbind(injections, tmp)
rm(tmp)

if(study == "maturation"){
  injections <- injections[grep("slv_01", injections$filename):nrow(injections),]
  injections <- injections[grepl("Pt", injections$filename), ]
  injections$type <- paste0(injections$pt, injections$time)
  injections <- injections[!grepl("MIX", injections$filename), ]
} else if(study == "tissues"){
  injections <- injections[grep("solv_rep1", injections$filename):nrow(injections),]
  injections <- injections[grepl("skin|pulp|seeds", injections$tissue),]
}

# Read the data
data_raw <- readMSData(
  paste0(study, "/data/", polarity, "_FS_fixed/" , injections$filename),
  pdata = as(AnnotatedDataFrame(injections),
             "NAnnotatedDataFrame"), 
  mode = "onDisk")
```


# Peak detection

```{r peak-detection}
cwp <- CentWaveParam(ppm = 20,
                     peakwidth = c(2, 20),
                     prefilter = c(5, int),
                     snthresh = 5,
                     noise = 1000,
                     mzdiff = 0.001,
                     integrate = 2)
xdata <- findChromPeaks(data_raw, param = cwp)
```


## Filter low-intensity peaks

```{r filter-intensity}
xdata <- refineChromPeaks(xdata, 
                          param = FilterIntensityParam(
                            nValues = 5, threshold = int)
)
```


## Peak post-processing

```{r peak-postproc}
mnp <- MergeNeighboringPeaksParam(
  expandRt = 2, 
  expandMz = 0.001, 
  ppm = 10,
  minProp = 0.66)
register(SerialParam())
xdata <- refineChromPeaks(xdata, param = mnp)
```


# Aligment

```{r aligment, eval = TRUE}
# Define the hook peaks
pdp <- PeakDensityParam(sampleGroups = pData(xdata)[,v.class],
                        minFraction = 1,#0.75,
                        binSize = 0.02,
                        bw = 3)
xdata <- groupChromPeaks(xdata, param = pdp)

# Perform the aligment
if(study == "tissues"){
  minfra <- 0.3
} else if(study == "maturation"){
  minfra <- 0.05
}
pgp <- PeakGroupsParam(span = 0.3,
                       minFraction = minfra)
xdata <- adjustRtime(xdata, param = pgp)
```


## Checking

The results from the alignment are shown below. 
To visualize the alignment results, the BPC for the whole data set is plotted.

```{r alignment-rtime-plot, fig.width = 12, fig.height = 10, eval = FALSE}
chr_raw <- chromatogram(xdata, aggregationFun = "max", 
                        adjustedRtime = FALSE)
chr_adj <- chromatogram(xdata, aggregationFun = "max")
par(mfrow = c(3, 1), mar = c(0, 4.3, 2, 0.1))
plot(chr_raw, peakType = "none", main = "BPC, raw")
plot(chr_adj, peakType = "none", main = "BPC, adjusted")
plotAdjustedRtime(xdata)
```


# Correspondance

```{r correspondance}
pdp <- PeakDensityParam(sampleGroups = pData(xdata)[,v.class],
                        minFraction = 1,#0.66,
                        minSamples = 3,#1,
                        binSize = 0.02,
                        bw = 1)
xdata <- groupChromPeaks(xdata, param = pdp)
```


# Peak filling

```{r peak-filling}
fcp <- ChromPeakAreaParam()
xdata <- fillChromPeaks(xdata, param = fcp)
```


# Save data

```{r save}
save(xdata, file = paste0(study, "/data/RData/data_XCMS_", polarity, ".RData"))
```


# Session information

```{r session}
Sys.time()-startpoint
devtools::session_info()
```