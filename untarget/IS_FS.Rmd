---
title: "Lipidomics - Untargeted: Internal Standards"
author: "Mar Garcia-Aloy"
output: 
  BiocStyle::html_document:
    toc: false
    number_sections: false
    toc_float: false
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE)
```


In this document I'm going to plot the extract ion chromatograms (EICs) and full scan (FS) spectra of internal standards (ISs) in `blank` samples (which are the ones that ONLY contain ISs). 
Since `blank` samples were only injected in FS mode, I'll have to use `study samples` to get the corresponding MS2 spectra.

# Libraries

```{r libraries, message=FALSE, warning=FALSE}
library(readxl)
library(xcms)
library(Spectra)
library(Rdisop)
library(CompoundDb)
library(MsCoreUtils)
```

# Data import

## Theoretical

```{r cmps}
cmps <- read_xlsx("C:/Users/garciaalom/Google Drive/laboratory/db_compounds.xlsx")
cmps <- cmps[which(cmps$ID_cmp == "C0612"):
               which(cmps$ID_cmp == "C0633"),]
cmps <- subset(cmps, select = c("ID_cmp", "compound", "formula", "lipidgrape_min", "lipidgrape_max"))

ions <- read_xlsx("C:/Users/garciaalom/Google Drive/projectes/lipidomics_shared/new_rt.xlsx", sheet = "IS") 
ions$compound <- ions$ID
ions <- subset(ions, select = c("compound", "POS", "NEG"))

cmps <- merge(cmps, ions, by = "compound")
rm(ions)

cmps$RT <- rowMeans(cmps[,c("lipidgrape_min", "lipidgrape_max")])
cmps <- cmps[order(cmps$RT), ]

target <- rbind(
  read_xlsx("C:/Users/garciaalom/Google Drive/projectes/lipidomics_shared/new_rt.xlsx", sheet = "POS"), 
  read_xlsx("C:/Users/garciaalom/Google Drive/projectes/lipidomics_shared/new_rt.xlsx", sheet = "NEG"))
```

## Experimental

```{r data-import}
for(p in c("POS", "NEG")){
  #pth <- paste0("tissues/data/", p, "_DDA_mzML/")
  pth <- paste0("tissues/data/", p, "_FS_fixed/") 
  fls <- list.files(pth) 
  #fls <- fls[grep("QC", fls)]
  fls <- fls[grep("blank", fls)]
  xdata <- readMSData(paste0(pth , fls),mode = "onDisk")
  ms2spec <- Spectra(paste0(pth, fls), backend = MsBackendDataFrame())
  assign(paste0("xdata_", p), xdata)
  assign(paste0("ms2_", p), ms2spec)
}
rm(p, pth, fls, xdata, ms2spec)
```

# Output

```{r output, fig.width=10}
for(i in seq(nrow(cmps))){
  print(cmps$compound[i])
  print(cmps$formula[i])
  i.mass <- getMolecule(cmps$formula[i])$exactmass
  print(unlist(mass2mz(i.mass, adduct = c("[M+H]+", "[M+NH4]+", "[M+Na]+", 
                                          "[M-H]-", "[M-H+HCOOH]-"))))
  i.rt <- cmps$RT[i]
  if(is.na(i.rt)){
    i.rt <- target$RT[target$NAME == cmps$compound[i]] + 0.3
  }
  if(length(i.rt) == 0){i.rt <- 15}
  for(p in c("POS", "NEG")){
    xdata <- get(paste0("xdata_", p))
    xdata2 <- filterFile(xdata, 2)
    if(p == "POS"){
      i.add <- c("[M+H]+", "[M+NH4]+", "[M+Na]+")
    } else if(p == "NEG"){
      i.add <- c("[M-H]-", "[M-H+HCOOH]-")
    }
    if(!is.na(cmps[i, p])){
      chr <- chromatogram(
        xdata, 
        mz = unlist(mass2mz(i.mass, cmps[i, p])) + 0.05 * c(-1, 1)
      )
      i.int <- max(intensity(chr[[2]])[closest(i.rt*60-10, rtime(chr[[2]])):
                                         closest(i.rt*60+10, rtime(chr[[2]]))], 
                   na.rm = TRUE)
      i.rt2 <- rtime(chr[[2]])[names(which.max(intensity(chr[[2]])[
        closest(i.rt*60-10, rtime(chr[[2]])):
          closest(i.rt*60+10, rtime(chr[[2]]))]))]
      
      par(mfrow = c(1, 2))
      plot(chr, xaxt="n")
      axis(1, at = seq(0, 60*30, 60), labels = seq(0, 30))
      points(i.rt2, i.int, pch = 8, col = 2)
      
      plot(chr, xaxt="n", xlim = i.rt*60 + 30 * c(-1, 1))
      axis(1, at = seq(0, 60*30, 3), labels = sprintf("%.2f", seq(0, 30, 3/60))) 
      points(i.rt2, i.int, pch = 8, col = 2)
      
      sps <- as.data.frame(xdata2[[closest(i.rt2, rtime(xdata2))]])
    } else {
      i.mz <- unlist(mass2mz(getMolecule(cmps$formula[i])$exactmass, 
                             adduct = i.add))
      if(p == "NEG"){
        par(mfrow = c(1, 2))
      } else if(p == "POS"){
        par(mfrow = c(1, 3))
      }
      for(j in seq(length(i.mz))){
        chr <- chromatogram(xdata, mz = i.mz[j] + 0.10 * c(-1, 1))
        i.int <- max(intensity(chr[[2]])[closest(i.rt*60-10, rtime(chr[[2]])):
                                           closest(i.rt*60+10, rtime(chr[[2]]))], 
                     na.rm = TRUE)
        plot(chr, xaxt="n")
        axis(1, at = seq(0, 60*30, 60), labels = seq(0, 30))
        points(i.rt*60, i.int, pch = 8, col = 2)
      }
      sps <- as.data.frame(xdata2[[closest(i.rt*60, rtime(xdata2))]])
    } # close if is.na cmps$NEG/POS[i]
    sps$irel <- sps$i / max(sps$i)
    par(mfrow = c(1, 1))
    plot(sps$mz, sps$irel, type = "h", xlab = "mz", ylab = "relative intensity",
         main = paste0(
           "FS at ", 
           round(rtime(xdata2[[closest(i.rt*60, rtime(xdata2))]])/60, 2), "min"))
    tmp <- c()
    for(k in seq(0, 3)){
      i.ion <- matchWithPpm(unlist(mass2mz(i.mass, i.add))+1.003355*k, sps$mz, ppm = 10)
      tmp <- c(tmp, unlist(i.ion))
      for(j in seq(length(i.ion))){
        if(length(i.ion[[j]]) > 0){
          if(sps$irel[i.ion[[j]]] > 0.1){
            text(sps$mz[i.ion[[j]]], sps$irel[i.ion[[j]]],  
                 round(sps$mz[i.ion[[j]]], 4), col = j+1) 
          }
          points(sps$mz[i.ion[[j]]], sps$irel[i.ion[[j]]], col = j+1, type = "h")
        }
      } 
    }
    idx <- which(sps$irel > 0.1)
    idx <- idx[!idx %in% tmp]
    if(length(idx) > 5){
      idx <- order(sps$irel, decreasing = T)
      idx <- idx[!idx %in% tmp]
      idx <- idx[1:5]
    }
    if(length(idx) > 0){
      text(sps$mz[idx], sps$irel[idx], round(sps$mz[idx], 4))
    }
  } # end polarity "p"
} # close compound "i"
```

# Session information

```{r session}
Sys.time()-startpoint
devtools::session_info()
```