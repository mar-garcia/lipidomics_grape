---
title: "Inter-class variability"
author: "Mar Garcia-Aloy"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    number_sections: false
    toc_float: true
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
knitr::opts_chunk$set(echo = FALSE)
```

In this document I'm going to plot the distribution/class of those compounds that present a high intra-class variability.


# Preliminaries

```{r, echo=TRUE}
study <- "maturation" # specify "maturation" or "tissues"

library(readxl)
library(ggplot2)
```

```{r, message=FALSE, echo=TRUE}
data <- read_xlsx(paste0("data/data_", study, ".xlsx"), sheet = "trans_data")
```

```{r}
colnames(data)[1] <- "ID"

class <- colnames(data)[-1]

if(study == "tissues"){
  class <- gsub("pt11_", "", class)
  class <- gsub("_.*", "", class)
} else if(study == "maturation"){
  class <- gsub("_Rep.*", "", class)
  class <- gsub("_MIX.*", "", class)
}

dt <- data[,-1]
if(study == "tissues"){
  dt <- dt[, class %in% c("seeds", "pulp", "skin")]
  cl <- class[class %in% c("seeds", "pulp", "skin")]
} else if(study == "maturation"){
  dt <- dt[, !grepl("QC", class)]
  cl <- class[!grepl("QC", class)]
}

# delete compounds with ALL NAs
na_n <- apply(dt, 1, function(x) length(which(is.na(x))))
dt <- dt[na_n < ncol(dt), ]
```

```{r, warning=FALSE}
rownames(dt) <- data$ID[na_n < ncol(dt)]
```


# Plots

```{r}
cv.class <- aggregate(t(dt), list(cl), function(x){(sd(x)/mean(x))*100})
cv.class <- setNames(data.frame(t(cv.class[,-1])), cv.class[,1])
cv.class[is.na(cv.class)] <- 0
cv.class$cv_max <- apply(cv.class, 1, max)
plot(cv.class$cv_max[order(cv.class$cv_max)], xlab = "", ylab = "CV %")
abline(h = 150, lty = 2, col = "grey")

idx <- which(cv.class$cv_max > 150)
```


```{r, fig.width = 15, fig.height = (ceiling(length(idx)/3)*4)}
p <- list()
for(i in seq(length(idx))){
  tmp_dt <- data.frame(
    value = t(dt[rownames(dt)[idx[i]],]),
    class = cl
  )
  tmp_dt$na <- is.na(tmp_dt$value)
  tmp_dt$value[is.na(tmp_dt$value)] <- 0
  p[[i]] <- ggplot(
    data = tmp_dt, 
    aes(x = class, y = value, 
        label = substring(rownames(tmp_dt), nchar(rownames(tmp_dt))))) + 
    geom_point(aes(color = class, shape = na), 
               position = position_jitter(0.1), size = 2) +
    geom_text(check_overlap = T) + 
    ggtitle(rownames(dt)[idx[i]]) +
    xlab("") + ylab("")
}
gridExtra::grid.arrange(grobs = p, ncol = 3)
```



# Session information

```{r session}
Sys.time()-startpoint
#devtools::session_info()
```
