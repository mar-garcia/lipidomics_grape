---
title: "Data analysis: maturation - GAMs"
author: "Mar Garcia-Aloy"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    toc: true
    number_sections: false
    toc_float: true
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Libraries

```{r libraries}
library(readxl)
library(xcms)
library(mgcv)
library(RColorBrewer)
library(VennDiagram)
library(pheatmap)
```


# Read data

```{r read-data}
# Import compound quantification data:
data <- read_xlsx("data/data_maturation.xlsx", sheet = "trans_data")
colnames(data)[1] <- "ID"

# Create a vector specifying the sample classes:
class <- colnames(data)[-1]
class <- gsub("_Rep.*", "", class)
class <- gsub("_MIX.*", "", class)
class[grep("QC", class)] <- "QC"

# Replace R problematic symbols in compound names:
data$ID <- gsub("[^0-9A-Za-z///' ]", "_", data$ID)
data$ID <- gsub("/", "_", data$ID)
data$ID <- gsub(" ", "_", data$ID)
data$ID <- gsub("__", "_", data$ID)
idx <- grep("_$", data$ID)
data$ID[idx] <- substr(data$ID[idx], 1, nchar(data$ID[idx])-1)
cmps <- data$ID
data <- data[,-1]
data <- sapply(data, as.numeric)
rownames(data) <- cmps

# Import metadata
brix <- readxl::read_excel("data/Grape_Brix_Datafile.xlsx")
brix <- rbind(brix, 
              c(2019, "diradamento", "corno - az. Oliva", "2019-09-17", "C", 0, 
                mean(brix$Brix[brix$data == "2019-09-17"])),
              c(2019, "diradamento", "corno - az. Oliva", "2019-09-24", "C", 0, 
                mean(brix$Brix[brix$data == "2019-09-24"])))
brix <- brix[order(brix$data, brix$Replicate), ]
```


# GAM

```{r gam}
set.seed(123)
dt <- t(imputeRowMinRand(as.matrix(data[, class != "QC"]), method = "from_to",
                         min_fraction = 1/100,
                         min_fraction_from = 1/1000))

stat.gam <- function(x){
  as.numeric(unlist(summary(
    gam(log10(x) ~ s(as.integer(as.Date(brix$data))), method = "REML")
  ))["s.table4"])
}
pval <- apply(FUN = stat.gam, MARGIN = 2, X = dt)
padj <- p.adjust(pval, "BH")
```


# Correlations with predicted values

```{r correlations}
xtime <- as.integer(as.Date(brix$data))
gam.cor.pred.pearson <- function(x){
  cor(log10(x), 
      predict(gam(log10(x) ~ s(xtime), method = "REML"), 
              data.frame(xtime = xtime)))
}
gam.cor.pred.spearman <- function(x){
  cor(log10(x), 
      predict(gam(log10(x) ~ s(xtime), method = "REML"), 
              data.frame(xtime = xtime)), method = "spearman")
}
gam.cor.pred.kendall <- function(x){
  cor(log10(x), 
      predict(gam(log10(x) ~ s(xtime), method = "REML"), 
              data.frame(xtime = xtime)), method = "kendall")
}

cor.prs <- apply(FUN = gam.cor.pred.pearson, MARGIN = 2, X = dt)
cor.spr <- apply(FUN = gam.cor.pred.spearman, MARGIN = 2, X = dt)
cor.knd <- apply(FUN = gam.cor.pred.kendall, MARGIN = 2, X = dt)

grid.newpage()
draw.triple.venn(
  area1 = sum(cor.prs > 0.7 & padj < 0.05),
  area2 = sum(cor.spr > 0.7 & padj < 0.05),
  area3 = sum(cor.knd > 0.7 & padj < 0.05),
  n12 = sum(cor.prs > 0.7 & cor.spr > 0.7 & padj < 0.05),
  n13 = sum(cor.prs > 0.7 & cor.knd > 0.7 & padj < 0.05),
  n23 = sum(cor.spr > 0.7 & cor.knd > 0.7 & padj < 0.05),
  n123 = sum(cor.prs > 0.7 & cor.spr > 0.7 & cor.knd > 0.7 & padj < 0.05),
  category = c("Pearson", "Spearman", "Kendell"),
  fill = c("#E69F00", "#56B4E9", "#009E73")
)
#gam.edf <- function(x){
#  summary(
#    gam(log10(x) ~s(as.integer(as.Date(brix$data))), method = "REML")
#  )$edf
#}
#edfs <- apply(FUN = gam.edf, MARGIN = 2, X = dt)
```


# Comparisions correlations

```{r comparisions}
col_group <- colorRampPalette(brewer.pal(9, "Set1"))(13)
names(col_group) <- unique(class[class != "QC"])
```


## Only Spearman

```{r spearman}
idx <- which(cor.prs < 0.7 & cor.spr > 0.7 & padj < 0.05)
par(mfrow =c(1, 2))
for(i in seq(length(idx))){
  y <- dt[,names(idx[i])]
  yna <- data[names(idx[i]), class != "QC"]
  gam_i <- gam(log10(y) ~ s(xtime), method = "REML")
  plot(gam_i, main = names(idx[i]))
  
  plot(xtime, log10(y), col = col_group[class[class != "QC"]], 
       pch = c(16, 8)[as.factor(is.na(yna))], 
       main = paste0("Pearson = ", round(cor.prs[names(idx)[i]], 3), 
                     "; Spearman = ", round(cor.spr[names(idx)[i]], 3)))
  lines(xtime, predict(gam_i, data.frame(xtime = xtime)), col = "red", lwd = 2)
}
```


## Only Pearson

```{r pearson}
idx <- which(cor.prs > 0.7 & cor.spr < 0.7 & padj < 0.05)
par(mfrow =c(1, 2))
for(i in seq(length(idx))){
  y <- dt[,names(idx[i])]
  yna <- data[names(idx[i]), class != "QC"]
  gam_i <- gam(log10(y) ~ s(xtime), method = "REML")
  plot(gam_i, main = names(idx[i]))
  
  plot(xtime, log10(y), col = col_group[class[class != "QC"]], 
       pch = c(16, 8)[as.factor(is.na(yna))], 
       main = paste0("Pearson = ", round(cor.prs[names(idx)[i]], 3), 
                     "; Spearman = ", round(cor.spr[names(idx)[i]], 3)))
  lines(xtime, predict(gam_i, data.frame(xtime = xtime)), col = "red", lwd = 2)
}
```


# Behaviour correlations

```{r}
idx <- which(padj < 0.05 & cor.prs > 0.7)

dt_pred <- matrix(NA, nrow = nrow(dt), ncol = ncol(dt), dimnames = dimnames(dt))
dt_pred <- dt_pred[,idx]

for(i in seq(ncol(dt_pred))){
  dt_pred[,i] <- predict(gam(log10(dt[,idx[i]]) ~ s(xtime), method = "REML"), 
                         data.frame(xtime = xtime))  
}


cormat <- cor(dt_pred)
pm <- pheatmap(cormat, show_colnames = F, show_rownames = F)

par(mfrow =c(1, 2))
for(i in pm$tree_row$order){
  print(names(idx[i]))
  y <- dt[,names(idx[i])]
  yna <- data[names(idx[i]), class != "QC"]
  gam_i <- gam(log10(y) ~ s(xtime), method = "REML")
  plot(gam_i, main = names(idx[i]))
  
  plot(xtime, log10(y), col = col_group[class[class != "QC"]], 
       pch = c(16, 8)[as.factor(is.na(yna))], 
       main = paste0("Pearson = ", round(cor.prs[names(idx)[i]], 3), 
                     "; Spearman = ", round(cor.spr[names(idx)[i]], 3)))
  lines(xtime, predict(gam_i, data.frame(xtime = xtime)), col = "red", lwd = 2)
}
```


# Others

```{r, eval = FALSE}
corsx <- cors[padj < 0.05]
table(cut(corsx , c(0, 0.5, 0.6, 0.7, 0.8, 0.9, 1)))
#edfs <- edfs[padj < 0.05]

#tmp <- edfs[order(edfs, decreasing = T)]
tmp <- corsx[order(corsx, decreasing = T)]



par(mfrow =c(1, 2))
for(i in seq(length(tmp))){
  y <- dt[,names(tmp[i])]
  gam_i <- gam(log10(y) ~ s(xtime), method = "REML")
  plot(gam_i, main = names(tmp[i]))
  
  plot(xtime, log10(y), col = col_group[class[class != "QC"]], pch = 16, 
       main = paste0("cor = ", round(corsx[names(tmp)[i]], 3), 
                     "; edf = ", round(edfs[names(tmp)[i]], 3)))
  lines(xtime, predict(gam_i, data.frame(xtime = xtime)), col = "red", lwd = 2)
}

```

```{r, eval = FALSE}
i <- which(colnames(dt) == "TAG52_15_FA16_3")
gam(log10(dt[, i]) ~ s(xtime), method = "REML")
gam.vcomp(gam(log10(dt[, i]) ~ s(xtime), method = "REML"))


i <- which(colnames(dt) == "TAG58_6_FA16_0")
gam(log10(dt[, i]) ~ s(xtime), method = "REML")
gam.vcomp(gam(log10(dt[, i]) ~ s(xtime), method = "REML"))


abx <- gam.vcomp(gam(log10(dt[, i]) ~ s(xtime), method = "REML"))
abx["s(xtime)", "lower"]
abx["s(xtime)", "upper"]

lwr <- c()
upr <- c()
for(i in seq(ncol(dt))){
  abx <- gam.vcomp(gam(log10(dt[, i]) ~ s(xtime), method = "REML"))
  lwr <- c(lwr, abx["s(xtime)", "lower"])
  upr <- c(upr, abx["s(xtime)", "upper"])
}

out <- data.frame(cbind(pval, padj, cors, lwr, upr))
out$ci_d <- out$upr - out$lwr

outx <- out[out$padj < 0.05,]

i <- which(colnames(dt) == "Lyso_PI_18_0")
y <- dt[,i]
gam_i <- gam(log10(y) ~ s(xtime), method = "REML")
plot(gam_i, main = paste0(colnames(data[i])))
```


# Session information

```{r session}
Sys.time()-startpoint
devtools::session_info()
```
